# План разработки мини-версии SimCity

## 1) Введение
Мини-игра в стиле SimCity с упором на три системы: **энергетика**, **экономика**, **популяция**. Дополнительно: **кредиты**, **тёмная стильная тема**, **SVG-спрайты** для построек. Цель — быстрый MVP с возможностью расширения.

---

## 2) Основные тезисы (скоуп MVP)
- Карта: сетка 20×20 (изменяемо), клетки трёх типов: *дорога*, *жилой участок (R)*, *промышленный участок (I)*, *энергетический объект (Power)*.
- Системы: энергетика → питание зданий; экономика → доходы/расходы; популяция → рост/миграция жителей.
- Кредит: взять/погасить, проценты, ограничение по сумме и сроку.
- UI: тёмная тема, минималистичный HUD, панель строительства, инфо-оверлеи (энергия/налоги/население).
- Графика: единый **SVG-спрайтшит** для построек и иконок, масштабируемость без потери качества.
- Сохранение: локально (LocalStorage/IndexedDB).
- Сим-тик: 1 тик = 1 игровой день (настраиваемо).

---

## 3) Технологический стек
- **Клиент:** TypeScript + React (или Solid) + Vite.
- **Состояние:** Zustand/Redux Toolkit.
- **Рендер карты:** SVG (для простоты и единого пайплайна) или Canvas для производительности; в MVP — SVG.
- **Тесты:** Vitest + React Testing Library.
- **Линтинг/формат:** ESLint + Prettier.
- **Дизайн-токены:** CSS variables (темы), Tailwind (по желанию).

---

## 4) Архитектура и ключевые абстракции
- `Game` — корневой оркестратор (петля тиков, пауза, скорость).
- `World` — карта, тайлы, ссылки на здания.
- `Building` (абстрактный): id, тип, стоимость строительства/содержания, потребление/генерация энергии, рабочие места, вместимость.
  - `Residential`, `Industrial`, `Road`, `PowerPlant` (подтипы).
- `Economy` — налоги, бюджет города, кредиты, расходы на обслуживание.
- `Population` — количество жителей, трудоспособные, занятые, удовлетворённость.
- `EnergyGrid` — генерация/потребление, распределение, отключения.
- `Loan`/`Bank` — кредиты (ставка, платёж, дефолт).
- `Policies` — параметры города (ставки налогов, лимиты).
- `Persistence` — сохранение/загрузка.
- `UI` — панель инструментов, оверлеи, модалки.
- События/шина: простые доменные события (`BuildingPlaced`, `DayEnded`, `LoanTaken`).

---

## 5) Игровой цикл (game loop)
1. Игрок строит здания (расход бюджета).
2. В конце каждого тика:
   - Энергетика: рассчитать доступ/дефицит, отметить отключения.
   - Экономика: собрать налоги, списать обслуживание, проценты/платёж по кредиту.
   - Популяция: пересчитать население (вместимость R, рабочие места I, доступ к энергии, удовлетворённость).
   - Обновить индикаторы UI, сохранить снапшот (по интервалу).

---

## 6) Системы (детали MVP)

### 6.1 Энергетика
- Источники: `PowerPlant` с параметрами: `capacityMW`, `operatingCost/day`.
- Потребление: суммарное по зданиям (`consumptionKW` у Residential/Industrial).
- Распределение: если `supply < demand`, вводим коэффициент обеспеченности `coverage = supply/demand`; часть зданий уходит в *brownout* (снижение эффективности) или *blackout* (0) — в MVP: случайное отключение по дефициту.
- Эффекты: при `coverage < 100%` — падение удовлетворённости, снижение производства/налогов.

### 6.2 Экономика
- Бюджет города: `balance`.
- Доходы: налоги с населения (`taxPerCitizen/day`) и промышленности (`taxPerWorkplace/day`).
- Расходы: обслуживание зданий, инфраструктуры, погашение кредита.
- Налоги регулируются в `Policies` в диапазоне (например) 0–20% и влияют на удовлетворённость/приток населения.

### 6.3 Популяция
- Вместимость: `Residential.capacity`.
- Трудоустройство: `Industrial.jobs`.
- Баланс: `employed = min(population, totalJobs)`.
- Рост/миграция: функция от удовлетворённости (энергия, налоги, занятость).
- Границы: `0 <= population <= residentialCapacity`.

### 6.4 Кредит (Loan)
- Поля: `principal`, `rateAPR`, `termDays`, `paymentPerDay` (аннуитет), `outstanding`, `nextDue`.
- Ограничения: один активный кредит (MVP), лимит по сумме относительно доходов/баланса.
- События: просрочка → штраф/снижение рейтинга города; дефолт в MVP не реализуем, только блок нового кредита.

---

## 7) UI/UX и тёмная тема
- **Тёмная тема** по умолчанию, светлая — опциональна.
- Дизайн-токены (CSS variables) для фона/текста/акцентов: `--bg-900`, `--bg-800`, `--fg-100`, `--accent`, `--grid-line`, `--danger`, `--success`.
- Шрифты: геометрический гротеск, размер базовый 14–16px.
- Контраст ≥ 4.5:1; крупные числа и компактные карточки метрик (бюджет, энергия, население).
- Оверлеи карты: Energy (покрытие), Taxes (тепловая карта дохода), Population (заселённость).
- Горячие клавиши: 1 — дороги, 2 — жилые, 3 — промышленные, 4 — электростанция, `Esc` — отмена.

---

## 8) SVG-спрайты (пайплайн)
- Хранение иконок/построек как отдельные SVG-файлы.
- Сборка в один **SVG-спрайт** (symbol) через скрипт (svgo + svgstore) на prebuild.
- Использование в коде: `<svg><use href="#building-residential" /></svg>`; масштаб через `viewBox` и `width/height`.
- Слои: базовая форма + тени/детали (простые, без сложных фильтров для производительности).
- Варианты состояния: normal / selected / no-power (через CSS class + цветовые токены).

---

## 9) Данные и формулы (стартовые значения)
```ts
type Money = number;

interface CityState {
  day: number;
  balance: Money;
  population: number;              // фактическое население
  satisfaction: number;            // 0..100
  taxes: { citizen: number; industry: number }; // 0..20 (%)
  loans: Loan | null;
}

interface BuildingBase {
  id: string;
  type: 'Road' | 'Residential' | 'Industrial' | 'PowerPlant';
  buildCost: Money;
  upkeepPerDay: Money;
  energyUseKW?: number;            // для R/I
}

interface Residential extends BuildingBase {
  type: 'Residential';
  capacity: number;                // макс. жителей
}

interface Industrial extends BuildingBase {
  type: 'Industrial';
  jobs: number;                    // рабочие места
  productivity: number;            // множитель 0..1 (энергия влияет)
}

interface PowerPlant extends BuildingBase {
  type: 'PowerPlant';
  capacityMW: number;              // доступная мощность
}
```

**Формулы (MVP):**
- `supplyKW = sum(power.capacityMW) * 1000`
- `demandKW = sum(R.energyUseKW + I.energyUseKW)`
- `coverage = clamp(supplyKW / demandKW, 0, 1)`
- `productivityI = coverage`
- `taxIncome = population * taxCitizen + totalJobsFilled * taxIndustry`
- `upkeep = sum(building.upkeepPerDay)`
- `balance' = balance + taxIncome - upkeep - loanPayment`
- `population' = clamp(population + f(satisfaction) - g(unemployment, highTaxes), 0, residentialCapacity)`

---

## 10) План работ по этапам

### Этап A — Каркас и карта (1–2 дня)
- [x] Vite + TS + React, базовая структура, ESLint/Prettier.
- [x] Состояние игры (`Game`, `World`, `CityState`), ивенты.
- [x] Рендер сетки 20×20.
- [ ] Выбор клетки, размещение `Road`.
- [ ] Панель инструментов (выбор типа постройки), undo/redo (простой стек).

### Этап B — Здания и экономика (2–3 дня)
- [x] Типы зданий: `Residential`, `Industrial`, `PowerPlant`.
- [ ] Стоимость строительства/обслуживания, изменение `balance`.
- [ ] Налоги (глобальные слайдеры), сбор в конце тика.
- [ ] Отчёт дня: доходы/расходы, всплывающая сводка.

### Этап C — Энергетика (1–2 дня)
- [x] Подсчёт `supply/demand`, `coverage`.
- [x] Влияние на производительность промышленности и удовлетворённость.
- [ ] Оверлей Energy (градиенты/иконки отключения).

### Этап D — Популяция (2 дня)
- [x] Вместимость жилых, рабочие места, занятость.
- [x] Формула роста/миграции на основе удовлетворённости/налогов/энергии.
- [ ] Оверлей Population (заселённость по клеткам).

### Этап E — Кредиты (1 день)
- [x] Модель `Loan`.
- [ ] Модалка «Взять кредит» (сумма, срок, ставка), расчёт платежа.
- [x] Списание процентов/платежей ежедневно.
- [ ] Ограничения/блокировки при просрочке.

### Этап F — UI тёмной темы и спрайты (1–2 дня)
- [ ] Ввести дизайн-токены, переключение тем (тёмная по умолчанию).
- [ ] Сборка **SVG-спрайта** (svgo + svgstore), подключение к компонентам.
- [ ] Состояния спрайтов: normal/selected/no-power через CSS.

### Этап G — Сохранение/загрузка (0.5 дня)
- [ ] Автосейв раз в N тиков, ручное сохранение/загрузка (LocalStorage).

### Этап H — Тесты и полировка (1–2 дня)
- [x] Юнит-тесты формул экономики/энергетики/кредитов.
- [ ] Снэпшот-тесты UI и E2E сценарий «построить-город-получить-доход».

---

## 11) Оптимизации (после MVP)
- Canvas-рендер для крупной карты, батчинг SVG-`<use>`.
- Система дорог: влияние на заселённость/логистику.
- Процедурные карты/биомы, политики города, события.
- Множественные электростанции с типами (ветер/уголь/атом).

---

## 12) Определение готовности (Definition of Done)
- Город из 20×20 можно застроить базовыми типами.
- Энергетика влияет на производительность и население.
- Экономика сходится: налоги/расходы/обслуживание/кредиты работают.
- Население растёт/падает в зависимости от условий.
- Тёмная тема активна, SVG-спрайты подключены.
- Есть сохранение/загрузка, базовые тесты зелёные.
